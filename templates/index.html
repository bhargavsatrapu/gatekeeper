{% extends 'base.html' %}
{% block content %}

<h1><i class="fas fa-flask"></i> Smart API Test Runner</h1>

{% if msg %}
<div class="notice">{{ msg }}</div>
{% endif %}

<div class="tabs">
  <section id="tab-upload" class="tab {% if not active_tab or active_tab == 'upload' %}active{% endif %}">
    <h2><i class="fas fa-upload"></i> Swagger Upload</h2>
    <div class="upload-section">
      <form action="/upload-swagger" method="post" enctype="multipart/form-data">
        <div class="file-upload-area">
          <input type="file" name="swagger_file" accept="application/json" required id="swagger-file-input" />
          <label for="swagger-file-input" class="file-upload-label">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Choose Swagger JSON file or drag & drop</span>
            <small>Supports .json files only</small>
          </label>
        </div>
        <div class="button-group">
          <button type="submit" id="upload-btn">
            <i class="fas fa-upload"></i> Upload
          </button>
          <button type="button" onclick="loadEndpoints()" id="view-endpoints-btn">
            <i class="fas fa-eye"></i> View Endpoints
          </button>
        </div>
      </form>
    </div>
    
    <div id="endpoints-section" class="endpoints-section" style="display: none;">
      <h3><i class="fas fa-list"></i> Loaded Endpoints</h3>
      <div class="endpoints-controls">
        <div class="search-input-wrapper">
          <i class="fas fa-search"></i>
        <input type="text" id="endpoint-search" placeholder="Search endpoints..." onkeyup="filterEndpoints()">
        </div>
        <button onclick="clearEndpoints()">
          <i class="fas fa-times"></i> Clear View
        </button>
      </div>
      <div id="endpoints-table-container" class="table-container">
        <!-- Endpoints will be loaded here -->
      </div>
    </div>
  </section>

  <section id="tab-generate" class="tab {% if active_tab == 'generate' %}active{% endif %}">
    <h2><i class="fas fa-magic"></i> Generate Testcases</h2>
    <div class="generate-section">
      <div class="info-card">
        <i class="fas fa-info-circle"></i>
        <p>Generate comprehensive test cases including positive, negative, edge cases, and authentication tests for all your API endpoints.</p>
      </div>
      <form action="/generate-testcases" method="post" id="generate-form">
        <button type="submit" id="generate-btn">
          <i class="fas fa-code"></i> Generate Testcases
        </button>
      </form>
      <div class="button-group" style="margin-top: 16px;">
        <button type="button" onclick="loadTestcases()" id="view-testcases-btn" style="display: {% if show_view_btn %}block{% else %}none{% endif %};">
          <i class="fas fa-eye"></i> View Testcases
        </button>
        <button type="button" onclick="clearTestcases()" id="clear-testcases-btn" style="display: none;">
          <i class="fas fa-times"></i> Clear View
        </button>
      </div>
    </div>
    
    <div id="testcases-section" class="testcases-section" style="display: none;">
      <h3><i class="fas fa-list-check"></i> Generated Test Cases</h3>
      <div class="testcases-controls">
        <div class="search-input-wrapper">
          <i class="fas fa-search"></i>
        <input type="text" id="testcase-search" placeholder="Search test cases..." onkeyup="filterTestcases()">
        </div>
        <select id="endpoint-filter" onchange="filterByEndpoint()">
          <option value="">All Endpoints</option>
        </select>
      </div>
      
      <!-- Loading State for Test Generation -->
      <div id="test-generation-loader" class="test-generation-loader" style="display: none;">
        <div class="loader-container">
          <div class="main-loader">
            <div class="loader-ring"></div>
            <div class="loader-ring"></div>
            <div class="loader-ring"></div>
          </div>
          <div class="loader-content">
            <h4><i class="fas fa-magic"></i> Generating Test Cases</h4>
            <p>Creating comprehensive test scenarios for your API endpoints...</p>
            <div class="loader-steps">
              <div class="step active">
                <i class="fas fa-cog fa-spin"></i>
                <span>Analyzing API endpoints</span>
              </div>
              <div class="step">
                <i class="fas fa-code"></i>
                <span>Generating positive test cases</span>
              </div>
              <div class="step">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Creating negative test scenarios</span>
              </div>
              <div class="step">
                <i class="fas fa-shield-alt"></i>
                <span>Building authentication tests</span>
              </div>
              <div class="step">
                <i class="fas fa-check-circle"></i>
                <span>Finalizing test suite</span>
              </div>
            </div>
            <div class="progress-info">
              <div class="progress-bar">
                <div class="progress-fill" id="generation-progress"></div>
              </div>
              <span class="progress-text">This may take 2-3 minutes...</span>
            </div>
          </div>
        </div>
      </div>
      
      <div id="testcases-container" class="testcases-container">
        <!-- Test cases will be loaded here -->
      </div>
    </div>
    
  </section>

  <section id="tab-positive" class="tab">
    <h2><i class="fas fa-check-circle"></i> Positive Tests</h2>
    <div class="info-card">
      <i class="fas fa-info-circle"></i>
      <p>Run basic positive tests to verify that each endpoint is working correctly before extensive testing.</p>
    </div>
    <form action="/run-positive" method="post">
      <button type="submit" id="run-positive-btn">
        <i class="fas fa-play"></i> Run Positive Flow
      </button>
    </form>
  </section>

  <section id="tab-all" class="tab">
    <h2><i class="fas fa-list-check"></i> All Tests</h2>
    <div class="info-card">
      <i class="fas fa-info-circle"></i>
      <p>Execute comprehensive testing including positive, negative, edge cases, and authentication tests for all endpoints.</p>
    </div>
    <form action="/run-all-tests" method="post">
      <button type="submit" id="run-all-btn">
        <i class="fas fa-rocket"></i> Run All Tests
      </button>
    </form>
  </section>

  <section id="tab-individual" class="tab">
    <h2><i class="fas fa-bullseye"></i> Test Individual Endpoints</h2>
    <div class="info-card">
      <i class="fas fa-info-circle"></i>
      <p>Select specific endpoints to test individually. This allows you to focus on particular APIs or test them in isolation.</p>
    </div>
    <div class="individual-endpoints-section">
      <div class="endpoints-controls">
        <button type="button" onclick="loadIndividualEndpoints()" id="load-individual-btn">
          <i class="fas fa-download"></i> Load Endpoints
        </button>
        <button type="button" onclick="clearIndividualEndpoints()" id="clear-individual-btn" style="display: none;">
          <i class="fas fa-times"></i> Clear View
        </button>
      </div>
      
      <div id="individual-endpoints-container" class="individual-endpoints-container" style="display: none;">
        <h3><i class="fas fa-mouse-pointer"></i> Select Endpoints to Test</h3>
        <div class="endpoints-grid" id="endpoints-grid">
          <!-- Endpoint cards will be loaded here -->
        </div>
        
        <div class="run-endpoints-section">
          <button type="button" onclick="runSelectedEndpoints()" id="run-endpoints-btn" disabled>
            <i class="fas fa-play"></i> Run Endpoints (<span id="selected-count">0</span> selected)
          </button>
        </div>
      </div>
    </div>
  </section>

  <section id="tab-console" class="tab {% if active_tab == 'console' %}active{% endif %}">
    <h2><i class="fas fa-terminal"></i> Execution Console</h2>
    <div class="console-controls">
      <button onclick="clearConsole()">
        <i class="fas fa-trash"></i> Clear Console
      </button>
      <button onclick="toggleAutoScroll()">
        <i class="fas fa-arrows-alt-v"></i> Auto Scroll: <span id="auto-scroll-status">ON</span>
      </button>
      <div id="console-status" class="console-status inactive">
        <i class="fas fa-circle" style="color: #6b7280;"></i> Paused
      </div>
    </div>
    <div id="console-output" class="console-output">
      <div class="console-line info">
        <i class="fas fa-info-circle"></i> Console ready. Execute tests to see logs...
      </div>
    </div>
  </section>

  <section id="tab-results" class="tab">
    <h2><i class="fas fa-message"></i> Latest Messages</h2>
    <div class="info-card">
      <i class="fas fa-info-circle"></i>
      <p>Success and error messages appear here after actions. The top bar notice also shows success messages.</p>
    </div>
  </section>

  <section id="tab-ai-reports" class="tab">
    <h2><i class="fas fa-robot"></i> AI Reports</h2>
    <div class="info-card">
      <i class="fas fa-info-circle"></i>
      <p>AI-powered analysis of your test execution results with insights, recommendations, and detailed reports.</p>
    </div>
    
    <!-- AI Reports Dashboard -->
    <div id="ai-reports-dashboard" class="ai-reports-dashboard">
      
      <!-- Controls -->
      <div class="reports-controls">
        <div class="analysis-info">
          <i class="fas fa-info-circle"></i>
          <span>Analyzing latest execution results from the database</span>
        </div>
        <div class="action-buttons">
          <button id="generate-analysis-btn" onclick="generateAIAnalysis()">
            <i class="fas fa-robot"></i> Generate Analysis
          </button>
          <button id="regenerate-analysis-btn" onclick="regenerateAIAnalysis()" style="display: none;">
            <i class="fas fa-sync-alt"></i> Regenerate Analysis
          </button>
          <button id="export-report-btn" onclick="exportReport()" style="display: none;">
            <i class="fas fa-download"></i> Export Report
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div id="ai-analysis-loader" class="ai-analysis-loader" style="display: none;">
        <div class="loader-content">
          <div class="ai-loader">
            <div class="brain-icon">
              <i class="fas fa-brain"></i>
            </div>
            <div class="loading-rings">
              <div class="ring"></div>
              <div class="ring"></div>
              <div class="ring"></div>
            </div>
          </div>
          <h3>AI Analysis in Progress</h3>
          <p>Analyzing test execution data and generating insights...</p>
          <div class="analysis-steps">
            <div class="step active">
              <i class="fas fa-database"></i>
              <span>Fetching execution data</span>
            </div>
            <div class="step">
              <i class="fas fa-chart-bar"></i>
              <span>Calculating metrics</span>
            </div>
            <div class="step">
              <i class="fas fa-robot"></i>
              <span>AI analysis</span>
            </div>
            <div class="step">
              <i class="fas fa-lightbulb"></i>
              <span>Generating insights</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary Metrics -->
      <div id="summary-metrics" class="summary-metrics" style="display: none;">
        <div class="metric-card">
          <div class="metric-icon">
            <i class="fas fa-list-check"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value" id="total-tests">0</div>
            <div class="metric-label">Total Tests</div>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-icon success">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value" id="passed-tests">0</div>
            <div class="metric-label">Passed</div>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-icon error">
            <i class="fas fa-times-circle"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value" id="failed-tests">0</div>
            <div class="metric-label">Failed</div>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-icon info">
            <i class="fas fa-percentage"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value" id="pass-rate">0%</div>
            <div class="metric-label">Pass Rate</div>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div id="charts-section" class="charts-section" style="display: none;">
        <div class="chart-container">
          <h3><i class="fas fa-chart-pie"></i> Test Results Distribution</h3>
          <div id="pass-fail-chart" class="chart"></div>
        </div>
      </div>

      <!-- Failed Tests Details -->
      <div id="failed-tests-details" class="failed-tests-details" style="display: none;">
        <h3><i class="fas fa-exclamation-triangle"></i> Failed Tests Details</h3>
        <div class="failed-tests-summary">
          <div class="summary-stats">
            <div class="stat-item">
              <span class="stat-label">Total Failed Tests:</span>
              <span class="stat-value" id="total-failed-count">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Most Common Error:</span>
              <span class="stat-value" id="most-common-error">None</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Failure Rate:</span>
              <span class="stat-value" id="overall-failure-rate">0%</span>
            </div>
          </div>
        </div>
        <div class="table-container">
          <table id="failed-tests-table">
            <thead>
              <tr>
                <th>Test Name</th>
                <th>Endpoint</th>
                <th>Method</th>
                <th>Expected Status</th>
                <th>Actual Status</th>
                <th>Error Type</th>
                <th>Failure Reason</th>
                <th>Timestamp</th>
              </tr>
            </thead>
            <tbody id="failed-tests-table-body">
            </tbody>
          </table>
        </div>
      </div>

      <!-- Endpoint Stability Table -->
      <div id="endpoint-stability" class="endpoint-stability" style="display: none;">
        <h3><i class="fas fa-shield-alt"></i> Endpoint Stability Analysis</h3>
        <div class="table-container">
          <table id="stability-table">
            <thead>
              <tr>
                <th>Endpoint</th>
                <th>Total Tests</th>
                <th>Failed Tests</th>
                <th>Failure Rate</th>
                <th>Priority</th>
                <th>Common Issues</th>
              </tr>
            </thead>
            <tbody id="stability-table-body">
            </tbody>
          </table>
        </div>
      </div>

      <!-- Schema Issues Table -->
      <div id="schema-issues" class="schema-issues" style="display: none;">
        <h3><i class="fas fa-code"></i> Schema Validation Issues</h3>
        <div class="table-container">
          <table id="schema-table">
            <thead>
              <tr>
                <th>Endpoint</th>
                <th>Issue Type</th>
                <th>Field Name</th>
                <th>Expected Type</th>
                <th>Actual Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody id="schema-table-body">
            </tbody>
          </table>
        </div>
      </div>

      <!-- AI Insights -->
      <div id="ai-insights" class="ai-insights" style="display: none;">
        <div class="insights-header">
          <h3><i class="fas fa-lightbulb"></i> AI Insights & Recommendations</h3>
        </div>
        <div class="insights-content">
          <div class="narrative-card">
            <h4><i class="fas fa-comment-dots"></i> Analysis Summary</h4>
            <p id="ai-narrative">Loading analysis...</p>
          </div>
          <div class="recommendations-card">
            <h4><i class="fas fa-tasks"></i> Recommendations</h4>
            <ul id="ai-recommendations"></ul>
          </div>
          <div class="fixes-card">
            <h4><i class="fas fa-wrench"></i> Suggested Fixes</h4>
            <div id="ai-suggested-fixes"></div>
          </div>
        </div>
      </div>

    </div>
  </section>
</div>


{% endblock %}


